<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArtisanPortal - Nouveau mot de passe</title>
  <link rel="stylesheet" href="/css/portal.css">
</head>
<body>
  <div class="auth-wrapper">
    <div class="auth-card">

      <!-- Loading -->
      <div id="loading-view" class="text-center">
        <p style="color: var(--slate-500);">Vérification du lien...</p>
      </div>

      <!-- Invalid token -->
      <div id="invalid-view" class="hidden text-center">
        <div class="auth-icon" style="background: #fee2e2; color: #dc2626; margin: 0 auto 16px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
        </div>
        <h1 class="auth-title">Lien invalide</h1>
        <p class="auth-subtitle" id="invalid-message">Ce lien de réinitialisation est invalide ou a expiré.</p>
        <a href="/pro/portail" class="btn btn-primary" style="display: inline-block; margin-top: 16px; text-decoration: none;">
          Retour à la connexion
        </a>
      </div>

      <!-- Set new password form -->
      <div id="reset-view" class="hidden">
        <div class="text-center mb-6">
          <div class="auth-icon purple">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4"/><path d="m21 2-9.6 9.6"/><circle cx="7.5" cy="15.5" r="5.5"/></svg>
          </div>
          <h1 class="auth-title">Nouveau mot de passe</h1>
          <p class="auth-subtitle">Créez un nouveau mot de passe sécurisé.</p>
        </div>

        <form id="reset-form">
          <div class="form-group">
            <label class="form-label">Nouveau mot de passe</label>
            <input type="password" id="new-password" class="form-input" placeholder="Minimum 6 caractères" required>
          </div>

          <div class="form-group">
            <label class="form-label">Confirmer le mot de passe</label>
            <input type="password" id="confirm-password" class="form-input" placeholder="Confirmer le mot de passe" required>
          </div>

          <div id="reset-error" class="alert alert-error hidden"></div>

          <button type="submit" id="reset-btn" class="btn btn-primary">Définir le nouveau mot de passe</button>
        </form>
      </div>

      <!-- Success -->
      <div id="success-view" class="hidden text-center">
        <div class="auth-icon green" style="margin: 0 auto 16px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
        </div>
        <h1 class="auth-title">Mot de passe modifié</h1>
        <p class="auth-subtitle">Votre mot de passe a été réinitialisé avec succès.</p>
        <a href="/pro/portail" class="btn btn-primary" style="display: inline-block; margin-top: 16px; text-decoration: none;">
          Se connecter
        </a>
      </div>

    </div>
  </div>

  <script>
    const token = new URLSearchParams(window.location.search).get('token');

    function showView(name) {
      ['loading', 'invalid', 'reset', 'success'].forEach(v =>
        document.getElementById(v + '-view').classList.add('hidden')
      );
      document.getElementById(name + '-view').classList.remove('hidden');
    }

    // Validate token on page load
    if (!token) {
      showView('invalid');
    } else {
      showView('reset');
    }

    document.getElementById('reset-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const errorEl = document.getElementById('reset-error');
      const btn = document.getElementById('reset-btn');

      errorEl.classList.add('hidden');

      if (newPassword !== confirmPassword) {
        errorEl.textContent = 'Les mots de passe ne correspondent pas.';
        errorEl.classList.remove('hidden');
        return;
      }

      if (newPassword.length < 6) {
        errorEl.textContent = 'Le mot de passe doit contenir au moins 6 caractères.';
        errorEl.classList.remove('hidden');
        return;
      }

      btn.textContent = 'Réinitialisation...';
      btn.disabled = true;

      try {
        const res = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, newPassword }),
        });

        const data = await res.json();

        if (data.success) {
          showView('success');
        } else {
          errorEl.textContent = data.error || 'Lien invalide ou expiré.';
          errorEl.classList.remove('hidden');
          btn.textContent = 'Définir le nouveau mot de passe';
          btn.disabled = false;
        }
      } catch {
        errorEl.textContent = 'Une erreur est survenue.';
        errorEl.classList.remove('hidden');
        btn.textContent = 'Définir le nouveau mot de passe';
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
